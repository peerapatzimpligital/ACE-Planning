# ACE-691 STORY-SOC-03: LINE OA Connector v1 Inbound Image Attachment Store and Link (Summary)

**‡∏™‡∏£‡∏∏‡∏õ Story**
Story ‡∏ô‡∏µ‡πâ (ACE-691) ‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó "‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image)" ‡∏à‡∏≤‡∏Å LINE Official Account ‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ô‡∏≥‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÅ‡∏ä‡∏ó (Unified Inbox) ‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÇ‡∏î‡∏¢‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:
1. **‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏¢‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Decoupled Persistence):** ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ Event ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ã‡∏ü‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• `Message` ‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏£‡πá‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á (Download) ‡πÅ‡∏•‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡∏ú‡∏π‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÅ‡∏ö‡∏ö Asynchronous (‡∏ó‡∏≥‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏á) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö Flow ‡∏´‡∏•‡∏±‡∏Å
2. **‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö (Download & Storage):** ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å LINE Content API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏î‡πÑ‡∏ü‡∏•‡πå Binary ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ô‡∏±‡πâ‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ô Object Storage (‡πÄ‡∏ä‡πà‡∏ô S3) ‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á `Attachment Record` ‡πÄ‡∏Å‡πá‡∏ö Metadata ‡πÅ‡∏•‡∏∞ `storage_key` 
3. **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏π‡∏õ (Secure Retrieval):** ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏à‡∏∞‡∏Ç‡∏≠‡∏î‡∏π‡∏£‡∏π‡∏õ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏î‡∏¥‡∏ö‡∏´‡∏£‡∏∑‡∏≠ Link S3 ‡∏ï‡∏£‡∏á‡πÜ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Signed URL ‡∏´‡∏£‡∏∑‡∏≠ Proxy Link ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (Expiry Date) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏≠‡∏á Tenant ‡∏ô‡∏±‡πâ‡∏ô‡∏à‡∏£‡∏¥‡∏á 
4. **‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏ô‡∏ó‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (Fault Tolerance):** ‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å LINE ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏•‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠ API ‡∏•‡πà‡∏°) ‡∏ï‡∏±‡∏ß `Message` (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏ó) ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏´‡∏≤‡∏¢‡πÑ‡∏õ ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á Attachment ‡∏ß‡πà‡∏≤ Failed ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏ (`failure_reason`) ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥ (Retry) ‡πÉ‡∏ô‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ (‡πÉ‡∏ô‡πÄ‡∏ü‡∏™ R1 ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÅ‡∏Ñ‡πà "‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û" ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏∑‡πà‡∏ô)

---

## üèóÔ∏è ‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡∏Å Subtasks (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏ï‡∏≤‡∏° Microservices ‡πÉ‡∏ô `ace/apps`)

**1. Event Normalization & Messaging Pipeline (`omnichat-normalizer-worker` / `packages/shared`)**
- [ ] ‡πÄ‡∏û‡∏¥‡πà‡∏° Type/Interface ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Inbound Event ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö `image` ‡∏à‡∏≤‡∏Å LINE 
- [ ] ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Normalization Pipeline ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏µ‡∏ï‡∏£‡∏≤‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Message ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏ï‡∏±‡∏ß Message ‡πÑ‡∏õ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡πà‡∏≠‡∏ô
- [ ] ‡∏™‡∏£‡∏∏‡∏õ/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï ER Diagram ‡∏Ç‡∏≠‡∏á `Attachment` Table ‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö Requirement

**2. Attachment Downloading & Processing (`file-service` / `omnichat-service`)**
- [ ] ‡∏û‡∏±‡∏í‡∏ô‡∏≤ Service ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ API ‡∏¢‡πà‡∏≠‡∏¢ (LINE Content API) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ Access Token ‡πÑ‡∏õ‡∏Ç‡∏≠ Download ‡πÑ‡∏ü‡∏•‡πå Binary 
- [ ] ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå (Storage Adapter) ‡∏ô‡∏≥‡πÑ‡∏ü‡∏•‡πå Binary ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ ‡πÑ‡∏õ‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏á Object Storage (‡πÄ‡∏ä‡πà‡∏ô AWS S3/MinIO) 
- [ ] ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏â‡∏µ‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏ã‡∏ü‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏ô‡∏≥ `storage_key` ‡πÅ‡∏•‡∏∞ Metadata (‡πÄ‡∏ä‡πà‡∏ô File Size, MIME type) ‡∏°‡∏≤‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô `Attachment Record` ‡∏•‡∏á Database

**3. Database Link & Failure Handling (`omnichat-service`)**
- [ ] ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï `Message` ‡πÅ‡∏•‡∏∞ `Attachment` ‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ô (Link `attachment_id` ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö ‚Äã`message_id`)
- [ ] ‡∏ß‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Error/Retry ‡∏Å‡∏£‡∏ì‡∏µ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å LINE ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ Message ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Attachment Status ‡∏ß‡πà‡∏≤ "Failed" ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏ö Reason Code ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢

**4. Secure Retrieval API (`api-gateway` / `file-service`)**
- [ ] ‡πÄ‡∏õ‡∏¥‡∏î Endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏ü‡∏•‡πå (File Retrieval API) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡πà Inbox
- [ ] ‡∏ù‡∏±‡∏á Logic ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Authentication (‡πÄ‡∏ä‡πá‡∏Ñ Tenant ID) ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡∏†‡∏≤‡∏û
- [ ] ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö Generate Signed URL (‡πÄ‡∏ä‡πà‡∏ô S3 Presigned URL) ‡∏´‡∏£‡∏∑‡∏≠ Proxy Stream ‡πÅ‡∏ö‡∏ö‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (Expiry) ‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ù‡∏±‡πà‡∏á Client (Inbox)

**5. Verification & Testing**
- [ ] ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Spec ‡∏ï‡∏≤‡∏° Technical Requirements 
- [ ] ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Unit Tests ‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥ Mocking (‡∏à‡∏≥‡∏•‡∏≠‡∏á) LINE Content API ‡πÅ‡∏•‡∏∞ Object Storage
- [ ] ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô Integration Tests ‡∏à‡∏≥‡∏•‡∏≠‡∏á Flow ‡∏ó‡∏∞‡∏•‡∏∏‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏£‡∏±‡∏ö Webhook ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡πà‡∏≠ Image -> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Message -> ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏•‡∏á S3 -> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Table ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏û‡∏±‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏±‡∏ß Message ‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≠‡∏î‡∏≠‡∏¢‡∏π‡πà
